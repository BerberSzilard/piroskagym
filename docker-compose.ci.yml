services:

  db:

    image: postgres:16

    environment:

      POSTGRES_DB: piroskagym

      POSTGRES_USER: piroska

      POSTGRES_PASSWORD: piroska

    ports:

      - "5432:5432"

    volumes:

      - ./api/sql/00_schema.sql:/docker-entrypoint-initdb.d/00_schema.sql:ro

      - ./api/sql/10_ci_seed.sql:/docker-entrypoint-initdb.d/10_ci_seed.sql:ro

    healthcheck:

      test: ["CMD-SHELL", "pg_isready -U piroska -d piroskagym"]

      interval: 2s

      timeout: 2s

      retries: 30



  api:

    build:

      context: ./api

    environment:

      DATABASE_URL: postgres://piroska:piroska@db:5432/piroskagym

      JWT_SECRET: ci_jwt_secret

      NODE_ENV: test

    depends_on:

      db:

        condition: service_healthy

    ports:

      - "14000:4000"
